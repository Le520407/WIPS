import Group from '../models/Group';
import GroupParticipant from '../models/GroupParticipant';
import GroupJoinRequest from '../models/GroupJoinRequest';

/**
 * Groups Webhook Service
 * Â§ÑÁêÜ WhatsApp Groups API ÁöÑ webhook ‰∫ã‰ª∂
 */

// Webhook ‰∫ã‰ª∂Á±ªÂûã
interface GroupLifecycleEvent {
  timestamp: string;
  group_id: string;
  type: 'group_create' | 'group_delete';
  request_id?: string;
  subject?: string;
  description?: string;
  invite_link?: string;
  join_approval_mode?: 'auto_approve' | 'approval_required';
  errors?: Array<{
    code: string;
    message: string;
    title: string;
    error_data?: {
      details: string;
    };
  }>;
}

interface GroupParticipantsEvent {
  timestamp: string;
  group_id: string;
  type: 'participant_added' | 'participant_removed' | 'participant_left' | 'participant_promoted' | 'participant_demoted';
  participants: Array<{
    wa_id: string;
    role?: 'admin' | 'member';
  }>;
}

interface GroupSettingsEvent {
  timestamp: string;
  group_id: string;
  type: 'settings_update';
  settings: {
    subject?: string;
    description?: string;
    icon?: string;
    join_approval_mode?: 'auto_approve' | 'approval_required';
  };
  errors?: Array<{
    code: string;
    message: string;
    title: string;
  }>;
}

interface GroupStatusEvent {
  timestamp: string;
  group_id: string;
  type: 'status_update';
  status: 'active' | 'suspended';
  reason?: string;
}

/**
 * Â§ÑÁêÜÁæ§ÁªÑÁîüÂëΩÂë®Êúü‰∫ã‰ª∂
 * - group_create: Áæ§ÁªÑÂàõÂª∫ÊàêÂäü/Â§±Ë¥•
 * - group_delete: Áæ§ÁªÑÂà†Èô§ÊàêÂäü/Â§±Ë¥•
 */
export const handleGroupLifecycleUpdate = async (event: GroupLifecycleEvent, userId: string) => {
  console.log('üîÑ Processing group lifecycle event:', {
    type: event.type,
    group_id: event.group_id,
    has_errors: !!event.errors
  });

  try {
    if (event.type === 'group_create') {
      if (event.errors && event.errors.length > 0) {
        // Áæ§ÁªÑÂàõÂª∫Â§±Ë¥•
        console.error('‚ùå Group creation failed:', event.errors);
        // ÂèØ‰ª•Âú®ËøôÈáåËÆ∞ÂΩïÈîôËØØÊó•ÂøóÊàñÈÄöÁü•Áî®Êà∑
        return {
          success: false,
          error: event.errors[0].message
        };
      }

      // Áæ§ÁªÑÂàõÂª∫ÊàêÂäü
      console.log('‚úÖ Group created successfully:', {
        group_id: event.group_id,
        subject: event.subject,
        invite_link: event.invite_link
      });

      // Êü•ÊâæÊàñÂàõÂª∫Áæ§ÁªÑËÆ∞ÂΩï
      const [group, created] = await Group.findOrCreate({
        where: {
          user_id: userId,
          group_id: event.group_id
        },
        defaults: {
          user_id: userId,
          group_id: event.group_id,
          subject: event.subject || '',
          description: event.description || null,
          invite_link: event.invite_link || null,
          join_approval_mode: event.join_approval_mode || 'auto_approve',
          total_participant_count: 1, // ÂàõÂª∫ËÄÖËá™Â∑±
          suspended: false,
          creation_timestamp: new Date(event.timestamp)
        }
      });

      if (!created) {
        // Êõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
        await group.update({
          subject: event.subject || group.subject,
          invite_link: event.invite_link || group.invite_link,
          join_approval_mode: event.join_approval_mode || group.join_approval_mode
        });
      }

      return {
        success: true,
        group_id: event.group_id,
        invite_link: event.invite_link
      };
    } else if (event.type === 'group_delete') {
      if (event.errors && event.errors.length > 0) {
        // Áæ§ÁªÑÂà†Èô§Â§±Ë¥•
        console.error('‚ùå Group deletion failed:', event.errors);
        return {
          success: false,
          error: event.errors[0].message
        };
      }

      // Áæ§ÁªÑÂà†Èô§ÊàêÂäü
      console.log('‚úÖ Group deleted successfully:', event.group_id);

      // Âà†Èô§Áæ§ÁªÑËÆ∞ÂΩï
      await Group.destroy({
        where: {
          user_id: userId,
          group_id: event.group_id
        }
      });

      // Âà†Èô§Áõ∏ÂÖ≥ÁöÑÂèÇ‰∏éËÄÖËÆ∞ÂΩï
      await GroupParticipant.destroy({
        where: { group_id: event.group_id }
      });

      // Âà†Èô§Áõ∏ÂÖ≥ÁöÑÂä†ÂÖ•ËØ∑Ê±ÇËÆ∞ÂΩï
      await GroupJoinRequest.destroy({
        where: { group_id: event.group_id }
      });

      return {
        success: true,
        group_id: event.group_id
      };
    }
  } catch (error) {
    console.error('Error handling group lifecycle event:', error);
    throw error;
  }
};

/**
 * Â§ÑÁêÜÁæ§ÁªÑÂèÇ‰∏éËÄÖ‰∫ã‰ª∂
 * - group_participants_add: ÂèÇ‰∏éËÄÖÂä†ÂÖ•
 * - group_participants_remove: ÂèÇ‰∏éËÄÖË¢´ÁßªÈô§/‰∏ªÂä®Á¶ªÂºÄ
 * - group_join_request_created: Âä†ÂÖ•ËØ∑Ê±ÇÂàõÂª∫
 * - group_join_request_revoked: Âä†ÂÖ•ËØ∑Ê±ÇÂèñÊ∂à
 */
export const handleGroupParticipantsUpdate = async (event: any, userId: string) => {
  console.log('üë• Processing group participants event:', {
    type: event.type,
    group_id: event.group_id
  });

  try {
    const group = await Group.findOne({
      where: {
        user_id: userId,
        group_id: event.group_id
      }
    });

    if (!group) {
      console.warn('‚ö†Ô∏è Group not found:', event.group_id);
      return { success: false, error: 'Group not found' };
    }

    if (event.type === 'group_participants_add') {
      // ÂèÇ‰∏éËÄÖÂä†ÂÖ•ÔºàÈÄöËøáÈÇÄËØ∑ÈìæÊé•ÊàñÊâπÂáÜÂä†ÂÖ•ËØ∑Ê±ÇÔºâ
      const participants = event.added_participants || [];
      
      for (const participant of participants) {
        await GroupParticipant.findOrCreate({
          where: {
            group_id: event.group_id,
            wa_id: participant.wa_id
          },
          defaults: {
            group_id: event.group_id,
            wa_id: participant.wa_id,
            joined_at: new Date(parseInt(event.timestamp) * 1000)
          }
        });
      }

      // Êõ¥Êñ∞ÂèÇ‰∏éËÄÖÊÄªÊï∞
      const participantCount = await GroupParticipant.count({
        where: { group_id: event.group_id }
      });
      await group.update({ total_participant_count: participantCount });

      console.log('‚úÖ Participants added:', participants.length);
    } else if (event.type === 'group_participants_remove') {
      // ÂèÇ‰∏éËÄÖÁßªÈô§ÊàñÁ¶ªÂºÄ
      const participants = event.removed_participants || [];
      
      for (const participant of participants) {
        await GroupParticipant.destroy({
          where: {
            group_id: event.group_id,
            wa_id: participant.wa_id
          }
        });
      }

      // Êõ¥Êñ∞ÂèÇ‰∏éËÄÖÊÄªÊï∞
      const participantCount = await GroupParticipant.count({
        where: { group_id: event.group_id }
      });
      await group.update({ total_participant_count: participantCount });

      console.log('‚úÖ Participants removed:', participants.length);
    } else if (event.type === 'group_join_request_created') {
      // Âä†ÂÖ•ËØ∑Ê±ÇÂàõÂª∫
      await GroupJoinRequest.findOrCreate({
        where: {
          group_id: event.group_id,
          wa_id: event.wa_id
        },
        defaults: {
          group_id: event.group_id,
          wa_id: event.wa_id,
          join_request_id: event.join_request_id,
          status: 'pending',
          request_time: new Date(parseInt(event.timestamp) * 1000)
        }
      });

      console.log('‚úÖ Join request created:', event.join_request_id);
    } else if (event.type === 'group_join_request_revoked') {
      // Âä†ÂÖ•ËØ∑Ê±ÇÂèñÊ∂à
      await GroupJoinRequest.update(
        { status: 'revoked' },
        {
          where: {
            group_id: event.group_id,
            join_request_id: event.join_request_id
          }
        }
      );

      console.log('‚úÖ Join request revoked:', event.join_request_id);
    }

    return { success: true };
  } catch (error) {
    console.error('Error handling group participants event:', error);
    throw error;
  }
};

/**
 * Â§ÑÁêÜÁæ§ÁªÑËÆæÁΩÆÊõ¥Êñ∞‰∫ã‰ª∂
 * - group_settings_update: Áæ§ÁªÑËÆæÁΩÆÊõ¥Êñ∞Ôºà‰∏ªÈ¢ò„ÄÅÊèèËø∞„ÄÅÂ§¥ÂÉèÁ≠âÔºâ
 */
export const handleGroupSettingsUpdate = async (event: any, userId: string) => {
  console.log('‚öôÔ∏è Processing group settings event:', {
    group_id: event.group_id,
    has_errors: !!event.errors
  });

  try {
    if (event.errors && event.errors.length > 0) {
      // ËÆæÁΩÆÊõ¥Êñ∞Â§±Ë¥•
      console.error('‚ùå Group settings update failed:', event.errors);
      return {
        success: false,
        error: event.errors[0].message
      };
    }

    const group = await Group.findOne({
      where: {
        user_id: userId,
        group_id: event.group_id
      }
    });

    if (!group) {
      console.warn('‚ö†Ô∏è Group not found:', event.group_id);
      return { success: false, error: 'Group not found' };
    }

    // Êõ¥Êñ∞Áæ§ÁªÑËÆæÁΩÆ
    const updateData: any = {};
    
    // Ê£ÄÊü•‰∏ªÈ¢òÊõ¥Êñ∞
    if (event.group_subject && event.group_subject.update_successful) {
      updateData.subject = event.group_subject.text;
    }
    
    // Ê£ÄÊü•ÊèèËø∞Êõ¥Êñ∞
    if (event.group_description && event.group_description.update_successful) {
      updateData.description = event.group_description.text;
    }

    if (Object.keys(updateData).length > 0) {
      await group.update(updateData);
      console.log('‚úÖ Group settings updated:', Object.keys(updateData));
    }

    return { success: true };
  } catch (error) {
    console.error('Error handling group settings event:', error);
    throw error;
  }
};

/**
 * Â§ÑÁêÜÁæ§ÁªÑÁä∂ÊÄÅÊõ¥Êñ∞‰∫ã‰ª∂
 * - group_suspend: Áæ§ÁªÑÊöÇÂÅú
 * - group_suspend_cleared: Áæ§ÁªÑÊÅ¢Â§ç
 */
export const handleGroupStatusUpdate = async (event: any, userId: string) => {
  console.log('üìä Processing group status event:', {
    group_id: event.group_id,
    type: event.type
  });

  try {
    const group = await Group.findOne({
      where: {
        user_id: userId,
        group_id: event.group_id
      }
    });

    if (!group) {
      console.warn('‚ö†Ô∏è Group not found:', event.group_id);
      return { success: false, error: 'Group not found' };
    }

    // Êõ¥Êñ∞Áæ§ÁªÑÁä∂ÊÄÅ
    const suspended = event.type === 'group_suspend';
    await group.update({ suspended });

    console.log(`‚úÖ Group status updated: ${suspended ? 'suspended' : 'active'}`);

    return { success: true };
  } catch (error) {
    console.error('Error handling group status event:', error);
    throw error;
  }
};

/**
 * ‰∏ª webhook Â§ÑÁêÜÂáΩÊï∞
 * Ê†πÊçÆ field Á±ªÂûãÂàÜÂèëÂà∞ÂØπÂ∫îÁöÑÂ§ÑÁêÜÂáΩÊï∞
 */
export const processGroupsWebhook = async (change: any, userId: string) => {
  const field = change.field;
  const value = change.value;

  console.log('üì® Processing groups webhook:', {
    field,
    has_groups: !!value.groups
  });

  if (!value.groups || value.groups.length === 0) {
    console.warn('‚ö†Ô∏è No groups data in webhook');
    return { success: false, error: 'No groups data' };
  }

  const results = [];

  for (const groupEvent of value.groups) {
    try {
      let result;

      switch (field) {
        case 'group_lifecycle_update':
          result = await handleGroupLifecycleUpdate(groupEvent, userId);
          break;

        case 'group_participants_update':
          result = await handleGroupParticipantsUpdate(groupEvent, userId);
          break;

        case 'group_settings_update':
          result = await handleGroupSettingsUpdate(groupEvent, userId);
          break;

        case 'group_status_update':
          result = await handleGroupStatusUpdate(groupEvent, userId);
          break;

        default:
          console.warn('‚ö†Ô∏è Unknown group webhook field:', field);
          result = { success: false, error: 'Unknown field type' };
      }

      results.push(result);
    } catch (error) {
      console.error('Error processing group event:', error);
      results.push({ success: false, error: (error as Error).message });
    }
  }

  return {
    success: results.every(r => r && r.success),
    results
  };
};
